(function(c,a){typeof exports=="object"&&typeof module!="undefined"?module.exports=a():typeof define=="function"&&define.amd?define(a):(c=typeof globalThis!="undefined"?globalThis:c||self,c.Magnus=a())})(this,function(){"use strict";const c=class{constructor(r){this.element=r,this.observer=new MutationObserver(this.observe.bind(this))}start(){this.observer.observe(this.element,this.getOptions()),this.handleNodes([this.element],!0)}stop(){this.observer.disconnect()}getAttributes(r,t){const e=r.split(" "),s=t.split(" "),n=[],o=[];for(const i of e)i!==""&&s.indexOf(i)===-1&&o.push(i);for(const i of s)i!==""&&e.indexOf(i)===-1&&n.push(i);return[n,o]}handleNodes(r,t){for(const e of r??[])e.nodeType===Node.ELEMENT_NODE&&(this.handleElement(e,t),this.handleNodes(e.childNodes,t))}observe(r){for(const t of r)t.type===c.CHILDLIST?(this.handleNodes(t.addedNodes,!0),this.handleNodes(t.removedNodes,!1)):t.type===c.ATTRIBUTES&&this.handleAttribute(t.target,t.attributeName??"",t.oldValue??"")}};let a=c;a.ATTRIBUTES="attributes",a.CHILDLIST="childList",a.OPTIONS={attributeOldValue:!0,attributes:!0,childList:!0,subtree:!0};class f extends a{constructor(t){super(t.element);this.context=t,this.attributeAction=`data-${t.identifier}-action`,this.attributeTarget=`data-${t.identifier}-target`}getOptions(){const t=Object.assign({},a.OPTIONS);return t.attributeFilter=[this.attributeAction,this.attributeTarget],t}handleAttribute(t,e,s,n){let o=t.getAttribute(e)??"";if(o===s)return;n===!0&&(s=o,o="");const i=e===this.attributeAction?this.handleAction:this.handleTarget;this.handleChanges(t,s,o,i)}handleElement(t,e){[this.attributeAction,this.attributeTarget].forEach(s=>{this.handleAttribute(t,s,"",!e)})}handleAction(t,e,s){if(this.context.store.actions.has(e)){this.context.store.actions[s?"add":"remove"](e,t);return}if(!s)return;const n=e.split(":");if(n.length<2)return;const o=this.context.controller[n[1]];typeof o=="function"&&(this.context.store.actions.create(e,n[0],o.bind(this.context.controller)),this.context.store.actions.add(e,t))}handleChanges(t,e,s,n){this.getAttributes(e,s).forEach((o,i)=>{const w=i===0;for(const O of o)n.call(this,t,O,w)})}handleTarget(t,e,s){this.context.store.targets[s?"add":"remove"](e,t)}}class g{constructor(){this.actions=new Map}add(t,e){const s=this.actions.get(t);s!=null&&(s.elements.add(e),e.addEventListener(s.type,s.callback))}clear(){this.actions.forEach((t,e)=>{t.elements.forEach(s=>{s.removeEventListener(t.type,t.callback)}),t.elements.clear()})}create(t,e,s){this.actions.has(t)||this.actions.set(t,{callback:s,elements:new Set,type:e})}has(t){return this.actions.has(t)}remove(t,e){const s=this.actions.get(t);s!=null&&(s.elements.delete(e),e.removeEventListener(s.type,s.callback),s.elements.size===0&&this.actions.delete(t))}}const h=class{constructor(r){this.store=r}get(r,t){return Reflect.get(r,t)}set(r,t,e){return this.handleValue(t,Reflect.get(r,t),e),Reflect.set(r,t,e)}getProperty(r){return r.replace(h.PATTERN,t=>t.toUpperCase())}handleValue(r,t,e){let s;if(this.store.callbacks.has(r)){s=this.store.callbacks.get(r),typeof s=="function"&&s.call(this.store.context.controller,e,t);return}s=this.store.context.controller[`data${this.getProperty(r)}Changed`],this.store.callbacks.set(r,s),typeof s=="function"&&s.call(this.store.context.controller,e,t)}};let u=h;u.PATTERN=/^\w/;class b{constructor(t){this.context=t,this.callbacks=new Map,this.handlers=new u(this),this.proxy=new Proxy({},this.handlers)}}class p{constructor(){this.targets=new Map}add(t,e){this.targets.has(t)?this.targets.get(t)?.add(e):this.targets.set(t,new Set).get(t)?.add(e)}clear(){this.targets.forEach((t,e)=>{t.clear()})}get(t){return Array.from(this.targets.get(t)??[])}has(t){return this.targets.has(t)}remove(t,e){const s=this.targets.get(t);s!=null&&(s.delete(e),s.size===0&&this.targets.delete(t))}}class T{constructor(t){this.actions=new g,this.data=new b(t),this.targets=new p}}class v{constructor(t,e,s,n){this.application=t,this.identifier=e,this.element=s,this.store=new T(this),this.observer=new f(this),this.controller=new n(this),this.observer.start(),typeof this.controller.connect=="function"&&this.controller.connect()}findElement(t){return this.element.querySelector(t)}findElements(t){return Array.from(this.element.querySelectorAll(t))}}class A{constructor(t){this.application=t,this.controllers=new Map}add(t,e){const s=this.controllers.get(t);if(s==null)return;const n=new v(this.application,t,e,s.controllerConstructor);e[t]=n.controller,s.instances.set(e,n.controller)}create(t,e){this.controllers.has(t)||this.controllers.set(t,{controllerConstructor:e,instances:new Map})}get(t){return Array.from(this.controllers.get(t)?.instances.values()??[])}remove(t,e){const s=this.controllers.get(t);if(s==null)return;const n=s.instances.get(e);n!=null&&(n.context.observer.stop(),n.context.store.actions.clear(),n.context.store.targets.clear(),delete e[t],s.instances.delete(e),typeof n.disconnect=="function"&&n.disconnect())}}const l=class extends a{constructor(r){super(document.documentElement);this.controllers=r}getOptions(){const r=Object.assign({},a.OPTIONS);return r.attributeFilter=[l.ATTRIBUTE],r}handleAttribute(r,t,e,s){let n=r.getAttribute(t)??"";n!==e&&(s===!0&&(e=n,n=""),this.handleChanges(r,n,e))}handleElement(r,t){r.hasAttribute(l.ATTRIBUTE)&&this.handleAttribute(r,l.ATTRIBUTE,"",!t)}handleChanges(r,t,e){this.getAttributes(e,t).forEach((s,n)=>{const o=n===0;for(const i of s)this.controllers[o?"add":"remove"](i,r)})}};let d=l;d.ATTRIBUTE="data-controller";class x{constructor(){this.controllers=new A(this),this.observer=new d(this.controllers)}add(t,e){this.controllers.create(t,e)}start(){this.observer.start()}stop(){this.observer.stop()}}class E{constructor(t){this.context=t}get data(){return this.context.store.data.proxy}get element(){return this.context.element}get identifier(){return this.context.identifier}hasTarget(t){return this.context.store.targets.has(t)}target(t){return this.context.store.targets.get(t)[0]}targets(t){return this.context.store.targets.get(t)}}var m={Application:x,Controller:E};return m});
