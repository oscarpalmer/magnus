/*!
 * Magnus, v0.6.0
 * https://github.com/oscarpalmer/magnus
 * (c) Oscar PalmÃ©r, 2021, MIT @license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Magnus=e()}(this,(function(){"use strict";class Observer{constructor(t,e){this.identifier=t,this.element=e,this.attributeAction=`data-${this.identifier}-action`,this.attributeTarget=`data-${this.identifier}-target`,this.mutationOptions=this.getOptions(),this.mutationObserver=new MutationObserver(this.observeMutations.bind(this))}disconnect(){this.mutationObserver.disconnect()}handleNodes(t,e){if(null!=t&&t.length>0)for(const s of t)s.nodeType===Node.ELEMENT_NODE&&(this.handleElement(s,e),this.handleNodes(s.childNodes,e))}observe(){this.mutationObserver.observe(this.element,Observer.MUTATION_OBSERVER_OPTIONS)}getAttributes(t,e){const s=t.split(" "),r=e.split(" "),o=[],n=[];for(const t of s)""!==t&&-1===r.indexOf(t)&&n.push(t);for(const t of r)""!==t&&-1===s.indexOf(t)&&o.push(t);return[o,n]}getOptions(){const t=Observer.MUTATION_OBSERVER_OPTIONS;return this.element===document.documentElement?(t.attributeFilter=[Observer.CONTROLLER_ATTRIBUTE],t):(t.attributeFilter=[this.attributeAction,this.attributeTarget],t)}observeMutations(t){var e,s;for(const r of t)r.type===Observer.MUTATION_RECORD_CHILDLIST?(this.handleNodes(r.addedNodes,!0),this.handleNodes(r.removedNodes,!1)):this.handleAttribute(r.target,null!==(e=r.attributeName)&&void 0!==e?e:"",null!==(s=r.oldValue)&&void 0!==s?s:"")}}Observer.CONTROLLER_ATTRIBUTE="data-controller",Observer.MUTATION_OBSERVER_OPTIONS={attributeOldValue:!0,attributes:!0,childList:!0,subtree:!0},Observer.MUTATION_RECORD_CHILDLIST="childList";class ControllerObserver extends Observer{constructor(t){super(t.identifier,t.element),this.controller=t}handleAttribute(t,e,s,r){var o;let n=null!==(o=t.getAttribute(e))&&void 0!==o?o:"";if(n===s)return;!0===r&&(s=n,n="");const i=e===this.attributeAction?this.handleAction:this.handleTarget;this.handleAttributeChanges(t,s,n,i)}handleElement(t,e){t.hasAttribute(this.attributeAction)&&this.handleAttribute(t,this.attributeAction,"",!e),t.hasAttribute(this.attributeTarget)&&this.handleAttribute(t,this.attributeTarget,"",!e)}handleAction(t,e,s){if(this.controller.context.store.hasAction(e))return void(s?this.controller.context.store.addAction(e,t):this.controller.context.store.removeAction(e,t));if(!s)return;const r=e.split(":");if(r.length<2)return;const o=this.controller[r[1]];"function"==typeof o&&(this.controller.context.store.createAction(e,r[0],o.bind(this.controller)),this.controller.context.store.addAction(e,t))}handleAttributeChanges(t,e,s,r){const o=this.getAttributes(e,s);for(let e=0;e<o.length;e+=1)this.toggleAttributes(t,o[e],r,0===e)}handleTarget(t,e,s){s?this.controller.context.store.addTarget(e,t):this.controller.context.store.removeTarget(e,t)}toggleAttributes(t,e,s,r){for(const o of e)s.call(this,t,o,r)}}class Store{constructor(){this.actions=new Map,this.targets=new Map}addAction(t,e){const s=this.actions.get(t);null!=s&&(s.elements.add(e),e.addEventListener(s.type,s.callback))}addTarget(t,e){var s,r;this.targets.has(t)?null===(s=this.targets.get(t))||void 0===s||s.add(e):null===(r=this.targets.set(t,new Set).get(t))||void 0===r||r.add(e)}createAction(t,e,s){this.actions.has(t)||this.actions.set(t,{callback:s,elements:new Set,type:e})}getTargets(t){var e;return Array.from(null!==(e=this.targets.get(t))&&void 0!==e?e:[])}hasAction(t){return this.actions.has(t)}removeAction(t,e){const s=this.actions.get(t);null!=s&&(e.removeEventListener(s.type,s.callback),s.elements.delete(e),0===s.elements.size&&this.actions.delete(t))}removeTarget(t,e){var s,r;this.targets.has(t)&&(null===(s=this.targets.get(t))||void 0===s||s.delete(e),0===(null===(r=this.targets.get(t))||void 0===r?void 0:r.size)&&this.targets.delete(t))}}class DocumentObserver extends Observer{constructor(t){super("magnus",document.documentElement),this.controllers=t}handleAttribute(t,e,s){var r;const o=null!==(r=t.getAttribute(e))&&void 0!==r?r:"";e===Observer.CONTROLLER_ATTRIBUTE&&o!==s&&this.handleControllerChanges(t,e,o,s)}handleElement(t,e){var s;if(!t.hasAttribute(Observer.CONTROLLER_ATTRIBUTE))return;const r=(null!==(s=t.getAttribute(Observer.CONTROLLER_ATTRIBUTE))&&void 0!==s?s:"").split(" ");this.toggleAttributes(t,r,e)}addControllerToElement(t,e){if(this.controllers.has(e)&&null==t[e]){const s=this.controllers.get(e);null!=s&&(t[e]=new s(e,t))}}handleControllerChanges(t,e,s,r){const o=this.getAttributes(r,s);for(let e=0;e<o.length;e+=1)this.toggleAttributes(t,o[e],0===e)}removeControllerFromElement(t,e){const s=t[e];null!=s&&(s.observer.disconnect(),delete t[e])}toggleAttributes(t,e,s){for(const r of e)s?this.addControllerToElement(t,r):this.removeControllerFromElement(t,r)}}class Magnus{constructor(){this.controllers=new Map,this.observer=new DocumentObserver(this.controllers)}add(t,e){this.controllers.set(t,e)}start(){this.observer.observe(),this.observer.handleNodes(document.documentElement.childNodes,!0)}stop(){this.observer.disconnect()}}return Magnus.Controller=class Controller{constructor(t,e){this.identifier=t,this.element=e,this.context={observer:new ControllerObserver(this),store:new Store},this.context.observer.observe(),this.context.observer.handleNodes(this.element.childNodes,!0),this.connect()}connect(){}target(t){return this.targets(t)[0]}targets(t){return this.context.store.getTargets(t)}},Magnus}));